{"version":3,"sources":["../../src/shared/context.service.ts"],"sourcesContent":["import { Inject, Injectable, Scope } from '@nestjs/common';\nimport { REQUEST } from '@nestjs/core';\n\nimport { IPayload, IRequest } from '@/interfaces';\n\nimport { SharedService } from './shared.service';\n\n/**\n * 上下文服务\n * @description 为请求上下文提供各种操作\n */\n@Injectable({\n  scope: Scope.REQUEST,\n})\nexport class ContextService {\n  constructor(\n    @Inject(REQUEST)\n    private request: IRequest,\n    private sharedService: SharedService,\n  ) {}\n  /**\n   * 获取 IP\n   */\n  getIP() {\n    return this.request.ip;\n  }\n\n  /**\n   * 获取 UA\n   */\n  getUA() {\n    return this.request.headers['user-agent'];\n  }\n\n  /**\n   * 在请求上下文设置载荷\n   * @param {IPayload} payload 载荷\n   */\n  setPayload(payload: IPayload) {\n    this.request.payload = payload;\n  }\n\n  /**\n   * 在请求上下文获取载荷\n   */\n  getPayload(): IPayload {\n    return this.request.payload;\n  }\n\n  /**\n   * 在请求上下文设置用户\n   * @param {IPayload} payload JWT 载荷\n   */\n  async setUser(payload: IPayload) {\n    const user =\n      await this.sharedService.getUserWithDeptRolesByPayload(payload);\n\n    this.request.user = user;\n  }\n\n  /**\n   * 从请求上下文获取用户\n   */\n  getUser() {\n    return this.request.user;\n  }\n\n  /**\n   * 从请求上下文获取用户带权限\n   */\n  getUserWithPermission() {\n    const user = this.getUser();\n\n    return this.sharedService.getUserWithPermission(user);\n  }\n}\n"],"names":["ContextService","getIP","request","ip","getUA","headers","setPayload","payload","getPayload","setUser","user","sharedService","getUserWithDeptRolesByPayload","getUser","getUserWithPermission","constructor","Injectable","scope","Scope","REQUEST","Inject"],"rangeMappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;","mappings":";;;;+BAcaA;;;eAAAA;;;wBAd6B;sBAClB;4BAEW;+BAEL;;;;;;;;;;;;;;;AASvB,IAAA,AAAMA,iBAAN,MAAMA;IAMX;;GAEC,GACDC,QAAQ;QACN,OAAO,IAAI,CAACC,OAAO,CAACC,EAAE;IACxB;IAEA;;GAEC,GACDC,QAAQ;QACN,OAAO,IAAI,CAACF,OAAO,CAACG,OAAO,CAAC,aAAa;IAC3C;IAEA;;;GAGC,GACDC,WAAWC,OAAiB,EAAE;QAC5B,IAAI,CAACL,OAAO,CAACK,OAAO,GAAGA;IACzB;IAEA;;GAEC,GACDC,aAAuB;QACrB,OAAO,IAAI,CAACN,OAAO,CAACK,OAAO;IAC7B;IAEA;;;GAGC,GACD,MAAME,QAAQF,OAAiB,EAAE;QAC/B,MAAMG,OACJ,MAAM,IAAI,CAACC,aAAa,CAACC,6BAA6B,CAACL;QAEzD,IAAI,CAACL,OAAO,CAACQ,IAAI,GAAGA;IACtB;IAEA;;GAEC,GACDG,UAAU;QACR,OAAO,IAAI,CAACX,OAAO,CAACQ,IAAI;IAC1B;IAEA;;GAEC,GACDI,wBAAwB;QACtB,MAAMJ,OAAO,IAAI,CAACG,OAAO;QAEzB,OAAO,IAAI,CAACF,aAAa,CAACG,qBAAqB,CAACJ;IAClD;IA3DAK,YACE,AACQb,OAAiB,EACzB,AAAQS,aAA4B,CACpC;aAFQT,UAAAA;aACAS,gBAAAA;IACP;AAwDL;AA7DaX;IAHZgB,IAAAA,kBAAU,EAAC;QACVC,OAAOC,aAAK,CAACC,OAAO;IACtB;IAGKC,aAAAA,IAAAA,cAAM,EAACD,aAAO;;;eACE,oBAAQ,4BAAR,oBAAQ;eACF,4BAAa,4BAAb,4BAAa;;GAJ3BnB"}