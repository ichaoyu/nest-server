{"version":3,"sources":["../../src/decorators/upload.decorator.ts"],"sourcesContent":["import { existsSync, mkdirSync } from 'node:fs';\nimport { tmpdir } from 'node:os';\nimport { join } from 'node:path';\n\nimport {\n  createParamDecorator,\n  ExecutionContext,\n  HttpException,\n  HttpStatus,\n} from '@nestjs/common';\n\nimport { IRequest, IUploadOptions } from '@/interfaces';\n\nconst defaultConfig: IUploadOptions = {\n  tmpdir: join(tmpdir(), 'nest-upload-files'),\n  preservePath: true,\n  limits: {\n    fileSize: 102400000, // 100mb\n  },\n};\n\n/**\n * 文件装饰器\n */\nexport const Files = createParamDecorator(\n  async (data: IUploadOptions, ctx: ExecutionContext) => {\n    const request = ctx.switchToHttp().getRequest<IRequest>();\n    const config = Object.assign(defaultConfig, data);\n\n    if (!existsSync(config.tmpdir)) {\n      try {\n        mkdirSync(config.tmpdir);\n      } catch (error) {\n        throw new HttpException(error, HttpStatus.INTERNAL_SERVER_ERROR);\n      }\n    }\n\n    try {\n      return await request.saveRequestFiles(config);\n    } catch (error) {\n      throw new HttpException(error.message, error.statusCode);\n    }\n  },\n);\n"],"names":["Files","defaultConfig","tmpdir","join","preservePath","limits","fileSize","createParamDecorator","data","ctx","request","switchToHttp","getRequest","config","Object","assign","existsSync","mkdirSync","error","HttpException","HttpStatus","INTERNAL_SERVER_ERROR","saveRequestFiles","message","statusCode"],"rangeMappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;","mappings":";;;;+BAwBaA;;;eAAAA;;;wBAxByB;wBACf;0BACF;wBAOd;AAIP,MAAMC,gBAAgC;IACpCC,QAAQC,IAAAA,cAAI,EAACD,IAAAA,cAAM,KAAI;IACvBE,cAAc;IACdC,QAAQ;QACNC,UAAU;IACZ;AACF;AAKO,MAAMN,QAAQO,IAAAA,4BAAoB,EACvC,OAAOC,MAAsBC;IAC3B,MAAMC,UAAUD,IAAIE,YAAY,GAAGC,UAAU;IAC7C,MAAMC,SAASC,OAAOC,MAAM,CAACd,eAAeO;IAE5C,IAAI,CAACQ,IAAAA,kBAAU,EAACH,OAAOX,MAAM,GAAG;QAC9B,IAAI;YACFe,IAAAA,iBAAS,EAACJ,OAAOX,MAAM;QACzB,EAAE,OAAOgB,OAAO;YACd,MAAM,IAAIC,qBAAa,CAACD,OAAOE,kBAAU,CAACC,qBAAqB;QACjE;IACF;IAEA,IAAI;QACF,OAAO,MAAMX,QAAQY,gBAAgB,CAACT;IACxC,EAAE,OAAOK,OAAO;QACd,MAAM,IAAIC,qBAAa,CAACD,MAAMK,OAAO,EAAEL,MAAMM,UAAU;IACzD;AACF"}