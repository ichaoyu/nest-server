{"version":3,"sources":["../../../src/fastify/hooks/on-request.hook.ts"],"sourcesContent":["import { EXTRAS } from '@/constants';\nimport { IRequest, IResponse } from '@/interfaces';\nimport { HashUtil } from '@/utils';\n\n/**\n * 请求拦截钩子\n */\nexport async function FastifyOnRequestHook(req: IRequest, res: IResponse) {\n  // 对匹配的路径做鉴权\n  if ([EXTRAS.QUEUES_PATH].includes(req.originalUrl)) {\n    const oldVal = req.cookies[EXTRAS.BASIC_AUTH_KEY] || '';\n    const isMatch = await HashUtil.compare(EXTRAS.BASIC_AUTH_RAW, oldVal);\n\n    if (!isMatch && !req.originalUrl.includes(EXTRAS.BASIC_AUTH_PATH)) {\n      res.redirect(302, `${EXTRAS.BASIC_AUTH_PATH}?url=${req.originalUrl}`);\n    }\n  }\n\n  return;\n}\n"],"names":["FastifyOnRequestHook","req","res","EXTRAS","QUEUES_PATH","includes","originalUrl","oldVal","cookies","BASIC_AUTH_KEY","isMatch","HashUtil","compare","BASIC_AUTH_RAW","BASIC_AUTH_PATH","redirect"],"rangeMappings":";;;;;;;;;;;;;;;;;;;;;;;;","mappings":";;;;+BAOsBA;;;eAAAA;;;2BAPC;uBAEE;AAKlB,eAAeA,qBAAqBC,GAAa,EAAEC,GAAc;IACtE,YAAY;IACZ,IAAI;QAACC,iBAAM,CAACC,WAAW;KAAC,CAACC,QAAQ,CAACJ,IAAIK,WAAW,GAAG;QAClD,MAAMC,SAASN,IAAIO,OAAO,CAACL,iBAAM,CAACM,cAAc,CAAC,IAAI;QACrD,MAAMC,UAAU,MAAMC,eAAQ,CAACC,OAAO,CAACT,iBAAM,CAACU,cAAc,EAAEN;QAE9D,IAAI,CAACG,WAAW,CAACT,IAAIK,WAAW,CAACD,QAAQ,CAACF,iBAAM,CAACW,eAAe,GAAG;YACjEZ,IAAIa,QAAQ,CAAC,KAAK,CAAC,EAAEZ,iBAAM,CAACW,eAAe,CAAC,KAAK,EAAEb,IAAIK,WAAW,CAAC,CAAC;QACtE;IACF;IAEA;AACF"}