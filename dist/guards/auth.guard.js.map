{"version":3,"sources":["../../src/guards/auth.guard.ts"],"sourcesContent":["import { CACHE_MANAGER } from '@nestjs/cache-manager';\nimport {\n  CanActivate,\n  ExecutionContext,\n  ForbiddenException,\n  Inject,\n  Injectable,\n  Scope,\n  UnauthorizedException,\n} from '@nestjs/common';\nimport { ConfigService } from '@nestjs/config';\nimport { Reflector } from '@nestjs/core';\nimport { JwtService } from '@nestjs/jwt';\n\nimport { EXTRAS, MESSAGES } from '@/constants';\nimport { Permission, Public } from '@/decorators';\nimport { ICacheManager, IRequest } from '@/interfaces';\nimport { ContextService } from '@/shared';\nimport { CacheUtil } from '@/utils';\n\n/**\n * 登录守卫\n */\n@Injectable({\n  scope: Scope.REQUEST,\n})\nexport class AuthGuard implements CanActivate {\n  constructor(\n    @Inject(CACHE_MANAGER)\n    private cacheManager: ICacheManager,\n    private configService: ConfigService,\n    private contextService: ContextService,\n    private jwtService: JwtService,\n    private reflector: Reflector,\n  ) {}\n\n  async canActivate(context: ExecutionContext) {\n    const request = context.switchToHttp().getRequest<IRequest>();\n    const apiPath = this.configService.get<string>('app.apiPath');\n    const permission = this.reflector.get(Permission, context.getHandler());\n\n    const isApi = request.url.includes(apiPath);\n    const isPublic = this.reflector.getAllAndOverride(Public, [\n      context.getHandler(),\n      context.getClass(),\n    ]);\n\n    // 匹配路径\n    if (!isApi || isPublic) {\n      return true;\n    }\n\n    // 请求头没有登录凭证\n    if (!request.headers.authorization) {\n      throw new UnauthorizedException(MESSAGES.AUTHORIZATION_NOT_EXIST);\n    }\n\n    const parts = request.headers.authorization.trim().split(' ');\n\n    // 请求头没有登录凭证\n    if (parts.length !== 2) {\n      throw new UnauthorizedException(MESSAGES.AUTHORIZATION_NOT_EXIST);\n    }\n\n    const [scheme, token] = parts;\n\n    if (/^Bearer$/i.test(scheme)) {\n      try {\n        const res = await this.jwtService.verify(token, {\n          complete: true,\n        });\n\n        if (typeof res !== 'string') {\n          const key = CacheUtil.getTokenKey(res.payload.sub);\n          const onlineInfo = await this.cacheManager.get<any>(key);\n\n          if (!onlineInfo) {\n            throw new UnauthorizedException(MESSAGES.AUTHORIZATION_NOT_CORRECT);\n          }\n\n          this.contextService.setPayload(res.payload);\n          await this.contextService.setUser(res.payload);\n\n          if (!permission) {\n            return true;\n          }\n\n          const { permissions } = this.contextService.getUserWithPermission();\n\n          // 管理员权限不做处理\n          if (permissions.includes(EXTRAS.ADMIN_PERMISSION)) {\n            return true;\n          }\n          // 没有权限时抛出错误\n          if (!permissions.includes(permission)) {\n            throw new ForbiddenException(\n              `${MESSAGES.NO_ACCESS} - ${request.method} ${request.url}`,\n            );\n          }\n          return true;\n        }\n      } catch (error) {\n        throw new UnauthorizedException(MESSAGES.AUTHORIZATION_EXPIRED);\n      }\n    } else {\n      throw new UnauthorizedException(MESSAGES.AUTHORIZATION_NOT_CORRECT);\n    }\n\n    return true;\n  }\n}\n"],"names":["AuthGuard","canActivate","context","request","switchToHttp","getRequest","apiPath","configService","get","permission","reflector","Permission","getHandler","isApi","url","includes","isPublic","getAllAndOverride","Public","getClass","headers","authorization","UnauthorizedException","MESSAGES","AUTHORIZATION_NOT_EXIST","parts","trim","split","length","scheme","token","test","res","jwtService","verify","complete","key","CacheUtil","getTokenKey","payload","sub","onlineInfo","cacheManager","AUTHORIZATION_NOT_CORRECT","contextService","setPayload","setUser","permissions","getUserWithPermission","EXTRAS","ADMIN_PERMISSION","ForbiddenException","NO_ACCESS","method","error","AUTHORIZATION_EXPIRED","constructor","Injectable","scope","Scope","REQUEST","Inject","CACHE_MANAGER"],"rangeMappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;","mappings":";;;;+BA0BaA;;;eAAAA;;;8BA1BiB;wBASvB;wBACuB;sBACJ;qBACC;2BAEM;4BACE;4BACK;wBACT;uBACL;;;;;;;;;;;;;;;AAQnB,IAAA,AAAMA,YAAN,MAAMA;IAUX,MAAMC,YAAYC,OAAyB,EAAE;QAC3C,MAAMC,UAAUD,QAAQE,YAAY,GAAGC,UAAU;QACjD,MAAMC,UAAU,IAAI,CAACC,aAAa,CAACC,GAAG,CAAS;QAC/C,MAAMC,aAAa,IAAI,CAACC,SAAS,CAACF,GAAG,CAACG,sBAAU,EAAET,QAAQU,UAAU;QAEpE,MAAMC,QAAQV,QAAQW,GAAG,CAACC,QAAQ,CAACT;QACnC,MAAMU,WAAW,IAAI,CAACN,SAAS,CAACO,iBAAiB,CAACC,kBAAM,EAAE;YACxDhB,QAAQU,UAAU;YAClBV,QAAQiB,QAAQ;SACjB;QAED,OAAO;QACP,IAAI,CAACN,SAASG,UAAU;YACtB,OAAO;QACT;QAEA,YAAY;QACZ,IAAI,CAACb,QAAQiB,OAAO,CAACC,aAAa,EAAE;YAClC,MAAM,IAAIC,6BAAqB,CAACC,mBAAQ,CAACC,uBAAuB;QAClE;QAEA,MAAMC,QAAQtB,QAAQiB,OAAO,CAACC,aAAa,CAACK,IAAI,GAAGC,KAAK,CAAC;QAEzD,YAAY;QACZ,IAAIF,MAAMG,MAAM,KAAK,GAAG;YACtB,MAAM,IAAIN,6BAAqB,CAACC,mBAAQ,CAACC,uBAAuB;QAClE;QAEA,MAAM,CAACK,QAAQC,MAAM,GAAGL;QAExB,IAAI,YAAYM,IAAI,CAACF,SAAS;YAC5B,IAAI;gBACF,MAAMG,MAAM,MAAM,IAAI,CAACC,UAAU,CAACC,MAAM,CAACJ,OAAO;oBAC9CK,UAAU;gBACZ;gBAEA,IAAI,OAAOH,QAAQ,UAAU;oBAC3B,MAAMI,MAAMC,gBAAS,CAACC,WAAW,CAACN,IAAIO,OAAO,CAACC,GAAG;oBACjD,MAAMC,aAAa,MAAM,IAAI,CAACC,YAAY,CAAClC,GAAG,CAAM4B;oBAEpD,IAAI,CAACK,YAAY;wBACf,MAAM,IAAInB,6BAAqB,CAACC,mBAAQ,CAACoB,yBAAyB;oBACpE;oBAEA,IAAI,CAACC,cAAc,CAACC,UAAU,CAACb,IAAIO,OAAO;oBAC1C,MAAM,IAAI,CAACK,cAAc,CAACE,OAAO,CAACd,IAAIO,OAAO;oBAE7C,IAAI,CAAC9B,YAAY;wBACf,OAAO;oBACT;oBAEA,MAAM,EAAEsC,WAAW,EAAE,GAAG,IAAI,CAACH,cAAc,CAACI,qBAAqB;oBAEjE,YAAY;oBACZ,IAAID,YAAYhC,QAAQ,CAACkC,iBAAM,CAACC,gBAAgB,GAAG;wBACjD,OAAO;oBACT;oBACA,YAAY;oBACZ,IAAI,CAACH,YAAYhC,QAAQ,CAACN,aAAa;wBACrC,MAAM,IAAI0C,0BAAkB,CAC1B,CAAC,EAAE5B,mBAAQ,CAAC6B,SAAS,CAAC,GAAG,EAAEjD,QAAQkD,MAAM,CAAC,CAAC,EAAElD,QAAQW,GAAG,CAAC,CAAC;oBAE9D;oBACA,OAAO;gBACT;YACF,EAAE,OAAOwC,OAAO;gBACd,MAAM,IAAIhC,6BAAqB,CAACC,mBAAQ,CAACgC,qBAAqB;YAChE;QACF,OAAO;YACL,MAAM,IAAIjC,6BAAqB,CAACC,mBAAQ,CAACoB,yBAAyB;QACpE;QAEA,OAAO;IACT;IAlFAa,YACE,AACQd,YAA2B,EACnC,AAAQnC,aAA4B,EACpC,AAAQqC,cAA8B,EACtC,AAAQX,UAAsB,EAC9B,AAAQvB,SAAoB,CAC5B;aALQgC,eAAAA;aACAnC,gBAAAA;aACAqC,iBAAAA;aACAX,aAAAA;aACAvB,YAAAA;IACP;AA4EL;AApFaV;IAHZyD,IAAAA,kBAAU,EAAC;QACVC,OAAOC,aAAK,CAACC,OAAO;IACtB;IAGKC,aAAAA,IAAAA,cAAM,EAACC,2BAAa;;;eACC,yBAAa,4BAAb,yBAAa;eACZ,qBAAa,4BAAb,qBAAa;eACZ,sBAAc,4BAAd,sBAAc;eAClB,eAAU,4BAAV,eAAU;eACX,eAAS,4BAAT,eAAS;;GAPnB9D"}