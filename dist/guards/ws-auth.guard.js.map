{"version":3,"sources":["../../src/guards/ws-auth.guard.ts"],"sourcesContent":["import { CACHE_MANAGER } from '@nestjs/cache-manager';\nimport {\n  CanActivate,\n  ExecutionContext,\n  HttpStatus,\n  Inject,\n  Injectable,\n} from '@nestjs/common';\nimport { Reflector } from '@nestjs/core';\nimport { JwtService } from '@nestjs/jwt';\nimport { WsException } from '@nestjs/websockets';\n\nimport { EXTRAS, MESSAGES } from '@/constants';\nimport { Permission } from '@/decorators';\nimport { ICacheManager } from '@/interfaces';\nimport { SharedService } from '@/shared';\nimport { CacheUtil } from '@/utils';\n\n/**\n * 登录守卫\n */\n@Injectable()\nexport class WsAuthGuard implements CanActivate {\n  constructor(\n    @Inject(CACHE_MANAGER)\n    private cacheManager: ICacheManager,\n    private jwtService: JwtService,\n    private reflector: Reflector,\n    private sharedService: SharedService,\n  ) {}\n\n  async canActivate(context: ExecutionContext) {\n    const ctx = context.switchToWs();\n    const data = ctx.getData();\n    const pattern = ctx.getPattern();\n    const permission = this.reflector.get(Permission, context.getHandler());\n\n    if (!data.headers?.authorization) {\n      throw new WsException({\n        code: HttpStatus.UNAUTHORIZED,\n        msg: MESSAGES.AUTHORIZATION_NOT_EXIST,\n      });\n    }\n\n    const parts = data.headers.authorization.trim().split(' ');\n\n    // 请求头没有登录凭证\n    if (parts.length !== 2) {\n      throw new WsException({\n        code: HttpStatus.UNAUTHORIZED,\n        msg: MESSAGES.AUTHORIZATION_NOT_EXIST,\n      });\n    }\n\n    const [scheme, token] = parts;\n\n    if (/^Bearer$/i.test(scheme)) {\n      try {\n        const res = await this.jwtService.verify(token, {\n          complete: true,\n        });\n\n        if (typeof res !== 'string') {\n          const key = CacheUtil.getTokenKey(res.payload.sub);\n          const onlineInfo = await this.cacheManager.get<any>(key);\n\n          if (!onlineInfo) {\n            throw new WsException({\n              code: HttpStatus.UNAUTHORIZED,\n              msg: MESSAGES.AUTHORIZATION_NOT_CORRECT,\n            });\n          }\n\n          if (!permission) {\n            return true;\n          }\n\n          const user = await this.sharedService.getUserWithDeptRolesByPayload(\n            res.payload,\n            'ws',\n          );\n          const { permissions } =\n            this.sharedService.getUserWithPermission(user);\n\n          // 管理员权限不做处理\n          if (permissions.includes(EXTRAS.ADMIN_PERMISSION)) {\n            return true;\n          }\n          // 没有权限时抛出错误\n          if (!permissions.includes(permission)) {\n            throw new WsException({\n              code: HttpStatus.FORBIDDEN,\n              msg: `${MESSAGES.NO_ACCESS} - ${pattern}`,\n            });\n          }\n          return true;\n        }\n      } catch (error) {\n        throw new WsException({\n          code: HttpStatus.UNAUTHORIZED,\n          msg: MESSAGES.AUTHORIZATION_EXPIRED,\n        });\n      }\n    } else {\n      throw new WsException({\n        code: HttpStatus.UNAUTHORIZED,\n        msg: MESSAGES.AUTHORIZATION_NOT_CORRECT,\n      });\n    }\n\n    return true;\n  }\n}\n"],"names":["WsAuthGuard","canActivate","context","ctx","switchToWs","data","getData","pattern","getPattern","permission","reflector","get","Permission","getHandler","headers","authorization","WsException","code","HttpStatus","UNAUTHORIZED","msg","MESSAGES","AUTHORIZATION_NOT_EXIST","parts","trim","split","length","scheme","token","test","res","jwtService","verify","complete","key","CacheUtil","getTokenKey","payload","sub","onlineInfo","cacheManager","AUTHORIZATION_NOT_CORRECT","user","sharedService","getUserWithDeptRolesByPayload","permissions","getUserWithPermission","includes","EXTRAS","ADMIN_PERMISSION","FORBIDDEN","NO_ACCESS","error","AUTHORIZATION_EXPIRED","constructor","Injectable","Inject","CACHE_MANAGER"],"rangeMappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;","mappings":"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"}