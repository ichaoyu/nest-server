{"version":3,"sources":["../../src/queues/login-log.processor.ts"],"sourcesContent":["import { Process, Processor } from '@nestjs/bull';\nimport { Job } from 'bull';\n\nimport { QUEUES } from '@/constants';\nimport { SharedService } from '@/shared';\nimport { SysUtil } from '@/utils';\n\n/**\n * 登陆日志队列\n */\n@Processor(QUEUES.LOGIN_LOG)\nexport class LoginLogProcessor {\n  constructor(private sharedService: SharedService) {}\n\n  @Process()\n  async execute(job: Job<any>) {\n    const { ip, userAgent, ...rest } = job.data;\n    const loginIp = await SysUtil.parseIP(ip);\n    const loginLocation = await SysUtil.parseAddress(loginIp);\n    const ua = SysUtil.parseUA(userAgent);\n    const os = ua.os.name;\n    const browser = ua.browser.name;\n\n    await this.sharedService.setLoginLog({\n      ...rest,\n      loginIp,\n      loginLocation,\n      browser,\n      os,\n    });\n\n    return {\n      loginIp,\n      loginLocation,\n      os,\n      browser,\n    };\n  }\n}\n"],"names":["LoginLogProcessor","execute","job","ip","userAgent","rest","data","loginIp","SysUtil","parseIP","loginLocation","parseAddress","ua","parseUA","os","name","browser","sharedService","setLoginLog","constructor","Process","Processor","QUEUES","LOGIN_LOG"],"rangeMappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;","mappings":";;;;+BAWaA;;;eAAAA;;;sBAXsB;uBACf;2BAEG;wBACO;uBACN;;;;;;;;;;AAMjB,IAAA,AAAMA,oBAAN,MAAMA;IAGX,MACMC,QAAQC,GAAa,EAAE;QAC3B,MAAM,EAAEC,EAAE,EAAEC,SAAS,EAAE,GAAGC,MAAM,GAAGH,IAAII,IAAI;QAC3C,MAAMC,UAAU,MAAMC,cAAO,CAACC,OAAO,CAACN;QACtC,MAAMO,gBAAgB,MAAMF,cAAO,CAACG,YAAY,CAACJ;QACjD,MAAMK,KAAKJ,cAAO,CAACK,OAAO,CAACT;QAC3B,MAAMU,KAAKF,GAAGE,EAAE,CAACC,IAAI;QACrB,MAAMC,UAAUJ,GAAGI,OAAO,CAACD,IAAI;QAE/B,MAAM,IAAI,CAACE,aAAa,CAACC,WAAW,CAAC;YACnC,GAAGb,IAAI;YACPE;YACAG;YACAM;YACAF;QACF;QAEA,OAAO;YACLP;YACAG;YACAI;YACAE;QACF;IACF;IAzBAG,YAAY,AAAQF,aAA4B,CAAE;aAA9BA,gBAAAA;IAA+B;AA0BrD;;IAxBGG,IAAAA,aAAO;;;eACW,UAAG,4BAAH,UAAG;;;GAJXpB;AAAAA;IADZqB,IAAAA,eAAS,EAACC,iBAAM,CAACC,SAAS;;;eAEU,qBAAa,4BAAb,qBAAa;;GADrCvB"}