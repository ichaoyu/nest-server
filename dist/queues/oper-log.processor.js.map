{"version":3,"sources":["../../src/queues/oper-log.processor.ts"],"sourcesContent":["import { Process, Processor } from '@nestjs/bull';\nimport { Job } from 'bull';\n\nimport { QUEUES } from '@/constants';\nimport { SharedService } from '@/shared';\nimport { SysUtil } from '@/utils';\n\n/**\n * 操作日志队列\n */\n@Processor(QUEUES.OPER_LOG)\nexport class OperLogProcessor {\n  constructor(private sharedService: SharedService) {}\n\n  @Process()\n  async execute(job: Job<any>) {\n    const { ip, operName, ...rest } = job.data;\n    const { dept } = await this.sharedService.getUserWithDeptByName(operName);\n    const { deptName } = dept;\n    const operIp = await SysUtil.parseIP(ip);\n    const operLocation = await SysUtil.parseAddress(operIp);\n\n    await this.sharedService.setOperLog({\n      ...rest,\n      deptName,\n      operName,\n      operIp,\n      operLocation,\n    });\n\n    return {};\n  }\n}\n"],"names":["OperLogProcessor","execute","job","ip","operName","rest","data","dept","sharedService","getUserWithDeptByName","deptName","operIp","SysUtil","parseIP","operLocation","parseAddress","setOperLog","constructor","Process","Processor","QUEUES","OPER_LOG"],"rangeMappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;","mappings":";;;;+BAWaA;;;eAAAA;;;sBAXsB;uBACf;2BAEG;wBACO;uBACN;;;;;;;;;;AAMjB,IAAA,AAAMA,mBAAN,MAAMA;IAGX,MACMC,QAAQC,GAAa,EAAE;QAC3B,MAAM,EAAEC,EAAE,EAAEC,QAAQ,EAAE,GAAGC,MAAM,GAAGH,IAAII,IAAI;QAC1C,MAAM,EAAEC,IAAI,EAAE,GAAG,MAAM,IAAI,CAACC,aAAa,CAACC,qBAAqB,CAACL;QAChE,MAAM,EAAEM,QAAQ,EAAE,GAAGH;QACrB,MAAMI,SAAS,MAAMC,cAAO,CAACC,OAAO,CAACV;QACrC,MAAMW,eAAe,MAAMF,cAAO,CAACG,YAAY,CAACJ;QAEhD,MAAM,IAAI,CAACH,aAAa,CAACQ,UAAU,CAAC;YAClC,GAAGX,IAAI;YACPK;YACAN;YACAO;YACAG;QACF;QAEA,OAAO,CAAC;IACV;IAnBAG,YAAY,AAAQT,aAA4B,CAAE;aAA9BA,gBAAAA;IAA+B;AAoBrD;;IAlBGU,IAAAA,aAAO;;;eACW,UAAG,4BAAH,UAAG;;;GAJXlB;AAAAA;IADZmB,IAAAA,eAAS,EAACC,iBAAM,CAACC,QAAQ;;;eAEW,qBAAa,4BAAb,qBAAa;;GADrCrB"}