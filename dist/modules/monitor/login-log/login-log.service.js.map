{"version":3,"sources":["../../../../src/modules/monitor/login-log/login-log.service.ts"],"sourcesContent":["import { Inject, Injectable } from '@nestjs/common';\nimport { InjectRepository } from '@nestjs/typeorm';\nimport { EXCEL_SERVICE, ExcelService } from '@/shared/excel';\nimport { Between, Like, Repository } from 'typeorm';\n\nimport { SysLoginLogEntity } from '@/database';\nimport { DelDTO } from '@/models';\n\nimport { FindLoginLogPageDTO } from './login-log.dto';\nimport { LoginLogExportSerialize } from './login-log.serialize';\n\n@Injectable()\nexport class LoginLogService {\n  constructor(\n    @Inject(EXCEL_SERVICE)\n    private excelService: ExcelService,\n    @InjectRepository(SysLoginLogEntity)\n    private loginLogModel: Repository<SysLoginLogEntity>,\n  ) {}\n\n  async handleFindPage(dto: FindLoginLogPageDTO) {\n    const {\n      pageNum,\n      pageSize,\n      beginDate,\n      endDate,\n      loginIp,\n      userName,\n      ...where\n    } = dto;\n\n    const [list, total] = await this.loginLogModel.findAndCount({\n      where: {\n        ...where,\n        userName: userName ? Like(`%${userName}%`) : null,\n        loginIp: loginIp ? Like(`%${loginIp}%`) : null,\n        loginDate: beginDate ? Between(beginDate, endDate) : null,\n      },\n      order: {\n        loginDate: 'DESC',\n      },\n      take: pageSize,\n      skip: (pageNum - 1) * pageSize,\n    });\n\n    return {\n      pageNum,\n      pageSize,\n      total,\n      list,\n    };\n  }\n\n  async handleExportPage(dto: FindLoginLogPageDTO) {\n    const { list } = await this.handleFindPage(dto);\n    return await this.excelService.handleExport({\n      sheetName: '登录日志',\n      fileName: '登录日志报表',\n      Cls: LoginLogExportSerialize,\n      data: list,\n    });\n  }\n\n  async handleDeleteMany(dto: DelDTO) {\n    const { ids } = dto;\n\n    await this.loginLogModel.delete(ids);\n  }\n\n  async handleClear() {\n    await this.loginLogModel.clear();\n  }\n}\n"],"names":["LoginLogService","handleFindPage","dto","pageNum","pageSize","beginDate","endDate","loginIp","userName","where","list","total","loginLogModel","findAndCount","Like","loginDate","Between","order","take","skip","handleExportPage","excelService","handleExport","sheetName","fileName","Cls","LoginLogExportSerialize","data","handleDeleteMany","ids","delete","handleClear","clear","constructor","Injectable","Inject","EXCEL_SERVICE","InjectRepository","SysLoginLogEntity"],"rangeMappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;","mappings":";;;;+BAYaA;;;eAAAA;;;wBAZsB;yBACF;uBACW;0BACF;0BAER;mCAIM;;;;;;;;;;;;;;;AAGjC,IAAA,AAAMA,kBAAN,MAAMA;IAQX,MAAMC,eAAeC,GAAwB,EAAE;QAC7C,MAAM,EACJC,OAAO,EACPC,QAAQ,EACRC,SAAS,EACTC,OAAO,EACPC,OAAO,EACPC,QAAQ,EACR,GAAGC,OACJ,GAAGP;QAEJ,MAAM,CAACQ,MAAMC,MAAM,GAAG,MAAM,IAAI,CAACC,aAAa,CAACC,YAAY,CAAC;YAC1DJ,OAAO;gBACL,GAAGA,KAAK;gBACRD,UAAUA,WAAWM,IAAAA,cAAI,EAAC,CAAC,CAAC,EAAEN,SAAS,CAAC,CAAC,IAAI;gBAC7CD,SAASA,UAAUO,IAAAA,cAAI,EAAC,CAAC,CAAC,EAAEP,QAAQ,CAAC,CAAC,IAAI;gBAC1CQ,WAAWV,YAAYW,IAAAA,iBAAO,EAACX,WAAWC,WAAW;YACvD;YACAW,OAAO;gBACLF,WAAW;YACb;YACAG,MAAMd;YACNe,MAAM,AAAChB,CAAAA,UAAU,CAAA,IAAKC;QACxB;QAEA,OAAO;YACLD;YACAC;YACAO;YACAD;QACF;IACF;IAEA,MAAMU,iBAAiBlB,GAAwB,EAAE;QAC/C,MAAM,EAAEQ,IAAI,EAAE,GAAG,MAAM,IAAI,CAACT,cAAc,CAACC;QAC3C,OAAO,MAAM,IAAI,CAACmB,YAAY,CAACC,YAAY,CAAC;YAC1CC,WAAW;YACXC,UAAU;YACVC,KAAKC,0CAAuB;YAC5BC,MAAMjB;QACR;IACF;IAEA,MAAMkB,iBAAiB1B,GAAW,EAAE;QAClC,MAAM,EAAE2B,GAAG,EAAE,GAAG3B;QAEhB,MAAM,IAAI,CAACU,aAAa,CAACkB,MAAM,CAACD;IAClC;IAEA,MAAME,cAAc;QAClB,MAAM,IAAI,CAACnB,aAAa,CAACoB,KAAK;IAChC;IA1DAC,YACE,AACQZ,YAA0B,EAClC,AACQT,aAA4C,CACpD;aAHQS,eAAAA;aAEAT,gBAAAA;IACP;AAsDL;AA5DaZ;IADZkC,IAAAA,kBAAU;IAGNC,aAAAA,IAAAA,cAAM,EAACC,oBAAa;IAEpBC,aAAAA,IAAAA,yBAAgB,EAACC,2BAAiB;;;eADb,mBAAY,4BAAZ,mBAAY;eAEX,oBAAU,4BAAV,oBAAU;;GALxBtC"}