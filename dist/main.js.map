{"version":3,"sources":["../src/main.ts"],"sourcesContent":["import { randomUUID } from 'node:crypto';\n\nimport fastifyCookie from '@fastify/cookie';\nimport fastifyMultipart from '@fastify/multipart';\nimport { ConfigService } from '@nestjs/config';\nimport { NestFactory } from '@nestjs/core';\nimport {\n  FastifyAdapter,\n  type NestFastifyApplication,\n} from '@nestjs/platform-fastify';\nimport { WsAdapter } from '@nestjs/platform-ws';\nimport { DocumentBuilder, SwaggerModule } from '@nestjs/swagger';\nimport { Logger } from 'nestjs-pino';\n\nimport { AppModule } from './app.module';\nimport { EXTRAS } from './constants';\nimport { FastifyOnRequestHook } from './fastify';\nimport { IConfig } from './interfaces';\n\nasync function bootstrap() {\n  const app = await NestFactory.create<NestFastifyApplication>(\n    AppModule,\n    new FastifyAdapter({ genReqId: () => randomUUID() }),\n    { bufferLogs: true },\n  );\n  const loggerService = app.get(Logger);\n  const configService = app.get(ConfigService);\n  const appConfig = configService.get<IConfig['app']>('app');\n\n  app.enableCors();\n  app.enableShutdownHooks();\n  app.useLogger(loggerService);\n  app.setGlobalPrefix(appConfig.apiPath);\n  // @ts-ignore\n  await app.register(fastifyCookie);\n  // @ts-ignore\n  await app.register(fastifyMultipart);\n\n  const instance = app.getHttpAdapter().getInstance();\n  instance.addHook('onRequest', FastifyOnRequestHook as any);\n\n  // WebSocket\n  const webSocketAdapter = new WsAdapter(app);\n  app.useWebSocketAdapter(webSocketAdapter);\n\n  const PORT = appConfig.port;\n  const DOC_PATH = appConfig.docPath;\n  const DOC_FILE = `${DOC_PATH}-json`;\n  /**\n   * 只有配置了 0.0.0.0 才能用本机 ip 访问，否则只能用 localhost 或 127.0.0.1 访问\n   * @see https://www.imooc.com/article/7581\n   */\n  const ADDRESS = '0.0.0.0';\n  const LOGGER_CONTEXT = 'NestApplication';\n\n  if (DOC_PATH) {\n    const config = new DocumentBuilder()\n      .setTitle('Nest Restful API')\n      .setDescription('Nest Restful API 模板接口文档')\n      .setVersion('1.0')\n      .addBearerAuth()\n      .build();\n    const document = SwaggerModule.createDocument(app, config);\n    SwaggerModule.setup(DOC_PATH, app, document);\n  }\n\n  await app.listen(PORT, ADDRESS, (err, address) => {\n    const ADDR = address.replace(ADDRESS, EXTRAS.LOCAL_IP);\n\n    loggerService.log(\n      `应用接口地址 ${ADDR}${appConfig.apiPath}`,\n      LOGGER_CONTEXT,\n    );\n\n    if (DOC_PATH) {\n      loggerService.log(`接口文档地址 ${ADDR}${DOC_PATH}`, LOGGER_CONTEXT);\n      loggerService.log(`接口文档数据 ${ADDR}${DOC_FILE}`, LOGGER_CONTEXT);\n    }\n  });\n}\nbootstrap();\n"],"names":["bootstrap","app","NestFactory","create","AppModule","FastifyAdapter","genReqId","randomUUID","bufferLogs","loggerService","get","Logger","configService","ConfigService","appConfig","enableCors","enableShutdownHooks","useLogger","setGlobalPrefix","apiPath","register","fastifyCookie","fastifyMultipart","instance","getHttpAdapter","getInstance","addHook","FastifyOnRequestHook","webSocketAdapter","WsAdapter","useWebSocketAdapter","PORT","port","DOC_PATH","docPath","DOC_FILE","ADDRESS","LOGGER_CONTEXT","config","DocumentBuilder","setTitle","setDescription","setVersion","addBearerAuth","build","document","SwaggerModule","createDocument","setup","listen","err","address","ADDR","replace","EXTRAS","LOCAL_IP","log"],"rangeMappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;","mappings":";;;;4BAA2B;+DAED;kEACG;wBACC;sBACF;iCAIrB;4BACmB;yBACqB;4BACxB;2BAEG;2BACH;yBACc;;;;;;AAGrC,eAAeA;IACb,MAAMC,MAAM,MAAMC,iBAAW,CAACC,MAAM,CAClCC,oBAAS,EACT,IAAIC,+BAAc,CAAC;QAAEC,UAAU,IAAMC,IAAAA,sBAAU;IAAG,IAClD;QAAEC,YAAY;IAAK;IAErB,MAAMC,gBAAgBR,IAAIS,GAAG,CAACC,kBAAM;IACpC,MAAMC,gBAAgBX,IAAIS,GAAG,CAACG,qBAAa;IAC3C,MAAMC,YAAYF,cAAcF,GAAG,CAAiB;IAEpDT,IAAIc,UAAU;IACdd,IAAIe,mBAAmB;IACvBf,IAAIgB,SAAS,CAACR;IACdR,IAAIiB,eAAe,CAACJ,UAAUK,OAAO;IACrC,aAAa;IACb,MAAMlB,IAAImB,QAAQ,CAACC,eAAa;IAChC,aAAa;IACb,MAAMpB,IAAImB,QAAQ,CAACE,kBAAgB;IAEnC,MAAMC,WAAWtB,IAAIuB,cAAc,GAAGC,WAAW;IACjDF,SAASG,OAAO,CAAC,aAAaC,6BAAoB;IAElD,YAAY;IACZ,MAAMC,mBAAmB,IAAIC,qBAAS,CAAC5B;IACvCA,IAAI6B,mBAAmB,CAACF;IAExB,MAAMG,OAAOjB,UAAUkB,IAAI;IAC3B,MAAMC,WAAWnB,UAAUoB,OAAO;IAClC,MAAMC,WAAW,CAAC,EAAEF,SAAS,KAAK,CAAC;IACnC;;;GAGC,GACD,MAAMG,UAAU;IAChB,MAAMC,iBAAiB;IAEvB,IAAIJ,UAAU;QACZ,MAAMK,SAAS,IAAIC,wBAAe,GAC/BC,QAAQ,CAAC,oBACTC,cAAc,CAAC,2BACfC,UAAU,CAAC,OACXC,aAAa,GACbC,KAAK;QACR,MAAMC,WAAWC,sBAAa,CAACC,cAAc,CAAC9C,KAAKqC;QACnDQ,sBAAa,CAACE,KAAK,CAACf,UAAUhC,KAAK4C;IACrC;IAEA,MAAM5C,IAAIgD,MAAM,CAAClB,MAAMK,SAAS,CAACc,KAAKC;QACpC,MAAMC,OAAOD,QAAQE,OAAO,CAACjB,SAASkB,iBAAM,CAACC,QAAQ;QAErD9C,cAAc+C,GAAG,CACf,CAAC,OAAO,EAAEJ,KAAK,EAAEtC,UAAUK,OAAO,CAAC,CAAC,EACpCkB;QAGF,IAAIJ,UAAU;YACZxB,cAAc+C,GAAG,CAAC,CAAC,OAAO,EAAEJ,KAAK,EAAEnB,SAAS,CAAC,EAAEI;YAC/C5B,cAAc+C,GAAG,CAAC,CAAC,OAAO,EAAEJ,KAAK,EAAEjB,SAAS,CAAC,EAAEE;QACjD;IACF;AACF;AACArC"}